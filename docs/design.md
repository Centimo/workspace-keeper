# Дизайн-документ: workspace-menu

## Цель

Предоставить быстрый и удобный интерфейс для управления виртуальными рабочими
столами KDE Plasma. Меню вызывается глобальным хоткеем, позволяет за несколько
нажатий переключиться на нужный workspace, создать новый или закрыть
существующий.

## Задачи

- Мгновенный отклик: запуск менее 200ms (popup-меню не должно тормозить)
- Управление исключительно с клавиатуры
- Визуальное разделение активных и сохранённых workspace'ов
- Автодополнение путей для создания workspace'а из произвольного каталога
- Интеграция с существующей shell-инфраструктурой управления workspace'ами

## Средства реализации

| Компонент | Технология | Обоснование |
|-----------|------------|-------------|
| UI | Qt6 Widgets (C++20) | Быстрый запуск без QML runtime / Scene Graph |
| Сборка | CMake 3.20+ | Стандарт для C++ проектов |
| Данные о десктопах | `wmctrl -d` | Единственный надёжный способ получить список виртуальных десктопов |
| Конфигурации | Файловая система | Простота, прозрачность, совместимость с shell-скриптами |
| IPC | Unix domain socket (`QLocalServer`) | Daemon-режим, мгновенный отклик при повторных вызовах |
| Интеграция | Файл результата + socket-ответ | Shell получает статус через socket, данные через файл |
| Docker | ubuntu:24.04 + qt6-base-dev | Воспроизводимая сборка |

### Почему Qt Widgets, а не QML

Первая версия использовала QML (Qt Quick). Она работала корректно, но запуск
занимал ~1 секунду из-за инициализации QML engine и Scene Graph. Для popup-меню,
которое вызывается хоткеем и должно появляться мгновенно, это неприемлемо.

Qt Widgets не требует QML runtime и стартует значительно быстрее. Визуальный
стиль полностью воспроизведён через QSS (Qt Style Sheets) и программное
управление стилями элементов списка.

## Архитектура

```
                    socat (shell)
                        │
                        ▼
┌──────────────────────────────────────────────────────┐
│                  Daemon_server                        │
│  QLocalServer: IPC, управление сессией                │
│                                                       │
│  ┌──────────────────────────────────────────────────┐ │
│  │                  Menu_window                      │ │
│  │  QWidget: окно, layout, обработка клавиш         │ │
│  │                                                   │ │
│  │  ┌─────────────┐  ┌───────────────────────────┐  │ │
│  │  │ QLineEdit   │  │ QListWidget               │  │ │
│  │  │ (фильтр)    │  │ (список workspace'ов)     │  │ │
│  │  └──────┬──────┘  └────────────┬──────────────┘  │ │
│  │         │                      │                  │ │
│  │         ▼                      ▼                  │ │
│  │  ┌─────────────────────────────────────────────┐  │ │
│  │  │            Workspace_menu                    │  │ │
│  │  │  Загрузка данных, действия, результат        │  │ │
│  │  │                                              │  │ │
│  │  │  ┌────────────────────────────────────────┐  │  │ │
│  │  │  │         Workspace_model                │  │  │ │
│  │  │  │  QAbstractListModel: entries,          │  │  │ │
│  │  │  │  фильтрация, навигация                 │  │  │ │
│  │  │  └────────────────────────────────────────┘  │  │ │
│  │  └─────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────┘
```

### Компоненты

**Daemon_server** — IPC-слой. Отвечает за:
- `QLocalServer` на Unix domain socket `/tmp/workspace-menu`
- Приём подключений от shell (через `socat`)
- Управление сессией: один активный клиент, отклонение повторных (`busy`)
- Передача результата (`done`/`cancelled`) обратно в shell

**Menu_window** — UI-слой. Содержит:
- `QLineEdit` — поле ввода фильтра
- `QLabel` — строка подсказок по клавишам
- `QListWidget` — список с кастомной стилизацией через `setItemWidget`
- Обработка клавиш через `eventFilter` на поле ввода
- Автозакрытие при потере фокуса (`changeEvent` / `ActivationChange`)
- `activate()` — точка входа сессии: загрузка данных, показ окна
- `finish_session()` — скрытие окна, сигнал `session_finished`

**Workspace_menu** — бизнес-логика. Отвечает за:
- Загрузку данных: парсинг `wmctrl -d`, чтение каталога `WORKSPACE_DIR`
- `begin_session()` — инициализация сессии с путём к файлу результата
- Действия: `select_current()`, `close_current()`, `tab_complete()`
- Запись результата в файл

**Workspace_model** — модель данных (`QAbstractListModel`). Управляет:
- Списком entries трёх типов: section header, workspace, path
- Перестроением списка при изменении фильтра
- Навигацией (пропуск нередактируемых заголовков секций)
- Вычислением tab completion для путей

## Протокол взаимодействия с shell

Приложение работает как демон. Shell-скрипт подключается к Unix domain socket,
отправляет запрос, получает ответ о результате. Данные результата передаются
через файл (как и раньше).

### IPC: Unix domain socket

Демон слушает `QLocalServer` на сокете `/tmp/workspace-menu`.
Shell подключается через `socat`.

**Запрос** (shell → демон):
```
show /tmp/workspace-menu-XXXXXX\n
```

**Ответ** (демон → shell):
```
done\n        # пользователь сделал выбор, результат в файле
cancelled\n   # Escape или потеря фокуса
busy\n        # меню уже открыто (отклонено)
```

### Формат файла результата

```
<action>
<data>
```

Две строки, разделённые `\n`.

### Действия

| action | data | Описание |
|--------|------|----------|
| `select` | имя workspace'а или путь | Переключиться на workspace (или создать, если не существует) |
| `custom_input` | текст из поля ввода | Создать workspace по произвольному пути |
| `close` | имя workspace'а | Сохранить и закрыть workspace |

### Жизненный цикл демона

```
Старт (autostart)
  │
  ├── QApplication (setQuitOnLastWindowClosed=false)
  ├── Menu_window (скрыто)
  ├── Daemon_server::start() → QLocalServer::listen
  └── app.exec()
       │
       ▼
  ┌─ IDLE (окно скрыто, слушаем сокет) ◄────────────┐
  │                                                   │
  │◄── socat: "show /tmp/result-XXX\n"                │
  │                                                   │
  ▼                                                   │
  ACTIVE                                              │
  │                                                   │
  ├── begin_session(result_file)                      │
  │   ├── load_data() (wmctrl + fs)                   │
  │   └── rebuild_model()                             │
  ├── show + raise + focus                            │
  │                                                   │
  │◄── пользователь: Enter/Escape/Alt+Del/focus loss  │
  │                                                   │
  ├── write_result (если не cancel)                   │
  ├── hide()                                          │
  ├── ответ "done\n"/"cancelled\n" → shell            │
  └── → IDLE ─────────────────────────────────────────┘
```

### Поток выполнения

```
Пользователь нажимает Alt+Tab
        │
        ▼
Shell: workspace menu
        │
        ├── mktemp → RESULT_FILE
        ├── socat: "show $RESULT_FILE" → socket
        ├── блокируется, ожидая ответ
        │
        ▼
Демон (уже запущен)
        │
        ├── on_new_connection() → read "show /tmp/..."
        ├── activate(result_file)
        │   ├── begin_session() — загрузка данных
        │   └── show + raise + focus
        ├── пользователь делает выбор
        ├── write_result → RESULT_FILE
        ├── hide()
        └── ответ "done\n" → shell
        │
        ▼
Shell: чтение RESULT_FILE
        │
        ├── select → переключение / создание desktop
        ├── custom_input → создание нового workspace
        └── close → сохранение вкладок + удаление desktop
```

## Конфигурация workspace'ов

```
$WORKSPACE_DIR/
├── project-alpha/
│   ├── project_dir       # одна строка: /home/user/projects/alpha
│   └── tabs.txt          # URL'ы вкладок браузера, по одному на строку
├── project-beta/
│   ├── project_dir
│   └── tabs.txt
└── ...
```

- Имя каталога = имя workspace'а (= имя виртуального десктопа KDE)
- `project_dir` — путь к проекту, отображается в меню рядом с именем
- `tabs.txt` — вкладки Floorp, восстанавливаемые при активации workspace'а

## Визуальный стиль

Тема Breeze Dark (KDE по умолчанию).

| Элемент | Цвет |
|---------|------|
| Фон окна | `#232627` |
| Рамка | `#3daee9`, 1px, radius 6px |
| Текст | `#fcfcfc` |
| Приглушённый текст | `#7f8c8d` |
| Accent (активный workspace, выделение) | `#1d99f3` |
| Выделенный элемент | фон `#1d99f3`, текст `#1a1a1a` |
| Фон заголовков секций | `#1e2123` |
| Шрифт | Hack, 18px (моноширинный) |

Окно: 600px ширина, без рамки WM, поверх всех окон, центрировано
горизонтально, 1/3 от верха экрана по вертикали.

## Типы записей в списке

| Тип | Флаги | Визуально |
|-----|-------|-----------|
| Section header | не выбирается, не активируется | bold 20px, dim цвет, тёмный фон, padding-left 5px |
| Workspace (active) | выбирается | accent цвет текста, padding-left 20px |
| Workspace (saved) | выбирается | белый текст, padding-left 20px |
| Path | выбирается | белый текст, padding-left 20px |
| Selected (любой) | — | фон accent, тёмный текст, пробел перед текстом |
